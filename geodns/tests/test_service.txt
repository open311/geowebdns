We'll look at the SQLAlchemy output, but not with the default format::

    >>> import logging, sys
    >>> logger = logging.getLogger('sqlalchemy')
    >>> formatter = logging.Formatter("%(levelname)s - %(message)s")
    >>> ch = logging.StreamHandler(sys.stdout)
    >>> ch.setLevel(logging.INFO)
    >>> ch.setFormatter(formatter)
    >>> logger.addHandler(ch)
    >>> logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)

First, import some data::

    >>> from geodns import importshp
    >>> import os
    >>> os.environ['SUPPRESS_LOGGING'] = '1'
    >>> importshp.main.func(
    ...     [os.path.join(os.path.dirname(importshp.__file__), 'tests/nycd_09b_av/'),
    ...     '--reset-database', '--commit',
    ...     '--row-pyfile=geodns.importhooks:import_community_board'])
    Dropping all tables
    ...
    INFO - COMMIT

First, some setup::

    >>> from geodns.wsgiapp import Application
    >>> from webtest import TestApp
    >>> app = TestApp(Application())

And a request for a location that has no information::

    >>> print app.get('/api1?lat=10&long=10&type=xxx')
    INFO - BEGIN
    INFO - SELECT jurisdiction.geom AS jurisdiction_geom, jurisdiction.id AS jurisdiction_id, jurisdiction.name AS jurisdiction_name, jurisdiction.uri AS jurisdiction_uri, jurisdiction.type_uri AS jurisdiction_type_uri, jurisdiction.updated AS jurisdiction_updated, jurisdiction.properties_json AS jurisdiction_properties_json 
    FROM jurisdiction 
    WHERE ST_Intersects(jurisdiction.geom, GeomFromText(%(GeomFromText_1)s, %(GeomFromText_2)s))
    INFO - {'GeomFromText_2': 4326, 'GeomFromText_1': 'POINT(10 10)'}
    Response: 200 OK
    Content-Type: application/json
    {"results": []}

Now, let's see all the types available::

    >>> print app.get('/api1/types')
    INFO - SELECT DISTINCT jurisdiction.type_uri 
    FROM jurisdiction
    INFO - {}
    Response: 200 OK
    Content-Type: application/json
    ["http://open311.org/community-board"]

Query one kind of type::

    >>> print app.get('/api1?lat=40.7941667&long=-73.9436111&type=http://open311.org/community-board')
    INFO - SELECT jurisdiction.geom AS jurisdiction_geom, jurisdiction.id AS jurisdiction_id, jurisdiction.name AS jurisdiction_name, jurisdiction.uri AS jurisdiction_uri, jurisdiction.type_uri AS jurisdiction_type_uri, jurisdiction.updated AS jurisdiction_updated, jurisdiction.properties_json AS jurisdiction_properties_json 
    FROM jurisdiction 
    WHERE ST_Intersects(jurisdiction.geom, GeomFromText(%(GeomFromText_1)s, %(GeomFromText_2)s))
    INFO - {'GeomFromText_2': 4326, 'GeomFromText_1': 'POINT(-73.9436111 40.7941667)'}
    Response: 200 OK
    Content-Type: application/json
    {"results": [{"kml_uri": "http://localhost/api1/kml/11", "uri": "http://open311.org/community-board/manhattan/11", "type": "http://open311.org/community-board", "properties": null, "name": "Manhattan Community Board #11"}]}

    >>> print app.get('/api1/kml/11')
    INFO - SELECT jurisdiction.id, jurisdiction.name, jurisdiction.uri, jurisdiction.type_uri, jurisdiction.updated, jurisdiction.geom, jurisdiction.properties_json 
    FROM jurisdiction 
    WHERE jurisdiction.id = %(id_1)s
    INFO - {'id_1': 11}
    INFO - SELECT ST_AsKML(%(param_1)s) AS "ST_AsKML_1"
    INFO - {'param_1': '...'}
    Response: 200 OK
    Content-Type: application/vnd.google-earth.kml+xml; charset=UTF-8
    <?xml version="1.0" encoding="UTF-8"?>
    <kml xmlns="http://www.opengis.net/kml/2.2">
      <Document>
        <Placemark>
          <name>Manhattan Community Board #11</name>
          <description>Manhattan Community Board #11: http://open311.org/community-board/manhattan/11</description>
    <MultiGeometry><Polygon><outerBoundaryIs><LinearRing><coordinates>...</coordinates></LinearRing></outerBoundaryIs></Polygon></MultiGeometry>
        </Placemark>
      </Document>
    </kml>

.. set the interpreter and other emacs stuff:

     Local Variables:
     mode: doctest
     doctest-python-command: "/home/ianb/src/geodns-app/bin/python"
     doctest-optionflags: ("ELLIPSIS")
     End:
